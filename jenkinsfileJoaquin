pipeline {
    agent any

    environment {
        // Configuración de la máquina remota
        remoteHost = '192.168.32.129'
        remoteUser = 'admin'
        privateKey = credentials('key_infra')
        dbname = 'joomla_db'
    }

    stages {
        stage('Construir imagen Docker') {
            steps {
                script {
                    // Construir imagen Docker con un nombre específico
                    appImagen = docker.build('app-imagen', '.')
                }
            }
        }

        stage('Construir y ejecutar contenedor Docker') {
            steps {
                 sshagent(credentials: ['key_infra']) {
                    // Establecer túnel SSH a la máquina de producción
                    sh "ssh -L 3307:localhost:3306 -N -f -o StrictHostKeyChecking=no ${remoteUser}@${remoteHost}"
                 script {
                    // Ejecutar docker-compose
                    sh 'usermod -aG docker ${remoteUser}'
                    sh 'sudo docker-compose up -d'
                 }

                }
                }
            }
        }
    }
